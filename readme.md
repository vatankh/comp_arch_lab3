
## Ватан Хатиб. P3319

asm | cisc | neum | hw | instr -> instr | struct | mem -> stream | pstr | prob1 | cache

**Базовый вариант**

---

### Язык программирования

```
program ::= { line }

line ::= label [ comment ] "\n"
       | instr [ comment ] "\n"
       | [ comment ] "\n"

label ::= label_name ":"

instr ::= op0
        | op1 integer
        | op1 char
        | op1 address
        | op2 address
        | op3 arg
        | op4 label_name

instr ::= op0
        | op1 integer
        | op1 char
        | op1 address
        | op2 address
        | op3 arg
        | op4 label_name

op0 ::= "inc"
      | "halt"
      | "pop"
      | "push"
      | "ret"
      | "strcmp"
      | "strcpy"
      | "strlen"

op1 ::= "load"
      | "store"
      | "mov"
      | "add"
      | "sub"
      | "mul"
      | "div"
      | "cmp"

op2 ::= "store"

op3 ::= "read"
      | "write"
      | "write_num"

op4 ::= "jmp"
      | "jz"
      | "call"
      | "ret"


integer ::= [ "-" ] { <any of "0-9"> }-

char ::= '<"a-z A-Z">'

address ::= <any of *> { <any of "0-9"> }

arg ::= <any of "0-9">

label_name ::= <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }

comment ::= ";" <any symbols except "\n">
```

---

### Операции

**_Data Manipulation Instructions:_**
- `load` - load data from memory into a register
- `store` - store data from a register into memory
- `mov` - move data between registers

**_Arithmetic Instructions:_**
- `add` - add two register values
- `sub` - subtract one register value from another
- `mul` - multiply two register values
- `div` - divide one register value by another
- `write_num` - write a number to output

**_Control Flow Instructions:_**
- `jmp` - unconditional jump to a specified address
- `jz` - jump if the value in the register is zero
- `call` - call a subroutine or function
- `ret` - return from a subroutine or function

**_I/O Instructions:_**
- `read` - read data from an I/O stream
- `write` - write data to an I/O stream

**_String Operations:_**
- `strcmp` - compare two strings
- `strcpy` - copy a string from one location to another
- `strlen` - get the length of a string

**_Other Instructions:_**
- `cmp` - compare two values
- `inc` - increment the value in a register by 1
- `halt` - stop the processor


---

### Метки

Метки могут быть определены в коде на отдельных строках или слева от инструкции:

```
label: load 0

label:
   load 0
```

В инструкции перехода, как и в инструкциях `call` и `func`, метки во время трансляции будут заменяться указателями на соответствующие инструкции в памяти.

Пример:

```asm
jmp label ; -> jmp 10
```

---

## Организация памяти

Модель памяти процессора:
1. Память команд и данных объединены (архитектура фон Неймана)
2. Память команд. Машинное слово реализуется как JSON структура для каждой инструкции.
3. Память данных. Машинное слово - 4 байта, знаковое. Реализуется списком чисел.
4. Процессор работает с регистрами, основной из которых - аккумулятор. 
5. Программист может обращаться к памяти данных, а инструкции `jmp`, `call` и `func` позволяют взаимодействовать с памятью команд.

```
 Регистры
+------------------------------+
| acc                          |
+------------------------------+

 Instruction memory
+------------------------------+
| 00  : instruction            |
| 01  : instruction            |
|             ...              |
| n   : program start          |
|             ...              |
| i   : instruction            |
| i+1 : instruction            |
|             ...              |
+------------------------------+

  Data memory
+------------------------------+
| 00  : variable/int_vector    |
| 01  : variable               |
|    ...                       |
| i-1 : variable               |
| i   : variable               |
+------------------------------+

```

Главное применение стека - работа с вызовами подпрограмм. Во время перехода на подпрограмму, в стек помещается адрес возврата, а при возврате - извлекается.

---

## Адресация

Операции с памятью поддерживают несколько типов адресации:

1. <ins>Прямая адресация</ins>: **instr 10** - использование константного значения.
   - **load 10** - загружает число 10.
   - **add 10** - производит сложение аккумулятора с числом 10.

2. <ins>Абсолютная адресация</ins>: **instr *10** - использование содержимого ячейки памяти.
   - **load *10** - загружает в аккумулятор значение из памяти.
   - **add *10** - складывает аккумулятор с содержимым ячейки памяти.

Инструкция "store" не поддерживает прямую адресацию.

## Система команд

### Особенности процессора

- Машинное слово данных - 4 байта. Операции с памятью и арифметические операции поддерживают несколько типов адресации.

- Есть три регистра: аккумулятор (acc), который используется для арифметических операций и хранения промежуточных данных, стековый регистр (stack_pointer), и адресный регистр (address_reg), указывающий на ячейки памяти для операций загрузки и хранения.

- Все регистры и данные из памяти (memory_bus) проходят через АЛУ для выполнения математических операций. Результат может быть сохранен в любой из регистров.

- Поток управления:
  - инкремент IP после каждой инструкции;
  - переходы управляются инструкциями перехода, командами `call` и `ret`.

### Набор инструкций

- A (Argument) - аргумент инструкции для работы с данными.
- M (Memory) - значение из памяти.
- <sup>n</sup>*M - значение из памяти по указателю в косвенной адресации.

**Операции с памятью**

| Инструкция |       Адресация       |  Кол-во тактов  | Мнемоника                        |
|------------|:---------------------:|:---------------:|----------------------------------|
| load       |    Прямая загрузка    |        1        | A -> ACC                         |
| load       |      Абсолютная       |        1        | M -> ACC                         | 
| store      |      Абсолютная       |        1        | ACC -> M                         |

**Арифметические операции**

| Инструкция |    Адресация    | Кол-во тактов | Мнемоника                   |
|------------|:---------------:|:-------------:|-----------------------------|
| add        | Прямая загрузка |       3       | ACC = ACC + A               |
| sub        | Прямая загрузка |       3       | ACC = ACC - A               |
| mul        | Прямая загрузка |       3       | ACC = ACC * A               |
| div        | Прямая загрузка |       3       | ACC = ACC / A               |

**Инструкции перехода**

- IP (Instruction Pointer) - указатель на текущую инструкцию

| Инструкция | Кол-во тактов | Мнемоника        |
|------------|:-------------:|------------------|
| jmp        |       1       | L -> IP          |
| jz         |       1       | if Z==1: L -> IP |

**Инструкции подпрограмм**

| Инструкция | Кол-во тактов | Мнемоника                                                        |
|------------|:-------------:|------------------------------------------------------------------|
| call       |       4       | SP = SP - 1, IP -> *SP, L -> IP                                  |
| ret        |       3       | *SP -> IP, SP = SP + 1                                           |

**Операции ввода-вывода**

| Инструкция | Кол-во тактов | Мнемоника      |
|------------|:-------------:|----------------|
| read       |       1       | Read data from stream   |
| write      |       1       | Write data to stream    |

**Машинные инструкции**

- Машинный код сериализуется в список JSON.
- Один элемент списка - одна инструкция. Например:

```
 [{
    "_start": 0
 },
 {
    "index": 0, 
    "opcode": "load", 
    "arg": "10"
 },
 {
    "index": 1, 
    "opcode": "add", 
    "arg": "20"
 },
 {
    "index": 2, 
    "opcode": "write", 
    "arg": null
 },
 {
    "index": 3, 
    "opcode": "halt"
 }]
```

## Транслятор

Интерфейс командной строки: `translator.py <input_file> <target_file>`

Реализовано в модуле: `translator.py`

### Алгоритм трансляции:

1. Дробление каждой строки на слова по пробелам.
2. Если строка пустая или содержит только комментарий, она пропускается.
3. Если строка содержит символ ":", то это метка, которая записывается в словарь меток с ключом метки и значением текущего индекса инструкции.
4. Если метка называется `_start` (точка входа в программу), этот индекс сохраняется отдельно.
5. Для каждой инструкции создается машинная инструкция с ключами `index`, `opcode`, и, если есть, `arg` (аргумент).
   - Если аргумент — это число или указатель, он просто записывается в `arg`.
   - Если аргумент — это символ, его код записывается в `arg`.
6. Во втором этапе трансляции, прохожу по машинным инструкциям еще раз и заменяю метки на соответствующие индексы инструкций.

## Модель процессора

Интерфейс командной строки: `machine.py <machine_code_file> <input_file>`

### ControlUnit

```
    +---------------------------- +1 ---------------------------------------+
    |                                                                       |
    |        +---------+                                                    |
    +------->|         |                +-----------------+        +-----------------+
      +----->|   MUX   |--------------->|   instruction   |---+--->|     program     |
      |  +-->|         |                |     pointer     |   |    |      memory     |
      |  |   +---------+                +-----------------+   |    +-----------------+
      |  |          ^                                         |             |
      |  +----------|-------------------- sel_arg --------------------------+
      |             |                                         |             |
      |             |                                         |             |
      |             |                                         V             V
      |             |                                    +------------------------+
      |             +------------- sel_next -------------|       instruction      |<-----------------------+
      |                                         +------->|         decoder        |                        |
      |                                         |        +------------------------+                      IntRq
      |                                         |             |             |                              |
      |                                         |             |             +--------+                     | 
      |                                         |          signals          |        |                     |
      |                                       flags           |           Buses      |              +--------------+
      |                                         |             |             |        |              |              |
      |                                         |             V             V        |              | Interruption |
      |                                         |           +-----------------+      |        +---->|  Controller  |
      |                                         +---------->|     DataPath    |      |        |     |              |
      |                                                     +-----------------+      |        |     |              |
      |                                                              |               |        |     +--------------+
      +----------------------------- data ---------------------------+---------------|--------+            ^
                                                                                     |                     |
                                                                                   delay,                IntRq 
                                                                                     ei                    |
                                                                                     |   +------------+    |
                                                                                     +-->|   Таймер   |----+
                                                                                         | прерываний |
                                                                                         +------------+ 
```

Реализован в классе ```ControlUnit```.

- Симуляция осуществляется в методе ```run```.
- В методе ```execute_instruction``` происходит декодирование и выполнение инструкций, включая арифметические, загрузку/сохранение данных и управление потоком.
- Время работы измеряется в тактах. Логирование состояния процессора можно добавить через модуль `logging`.
- Лог включает:
    - текущую инструкцию,
    - значения регистров,
    - состояние кэша,
    - данные на шинах,
    - флаги,
    - запросы на прерывания.
    
- Процессор выполняет инструкции до тех пор, пока не встретится инструкция `HALT`.

### DataPath

```
                  latch_acc
                       |                              +-------------------memory_out--------------------+
                       V                              |                                                 |
                +-------------+                       |               +---------------+                 |
                |             |                       |               |               |                 |
  output <--+---| Accumulator |-------------------+   |      +--------|    buf_reg    |<-----+     +----------+
            |   |             |                   |   |      |        |               |      |     |          |
            |   +-------------+                   |   |      |        +---------------+      |     |          |
            |          ^                          |   |      |                ^              |     |          |
            |          |                          |   |      |                |              |     |          |
            |          |                          |   |      |            latch_buf          |     |          |
            |          |                          |   |      |                               |     |          |
            |          |                          |   |      |         +---------------+     |     |          |
            |   +-------------+                   |   |      |         |               |     |     |          |<--read---  
            +-->|     MUX     |<-----sel_acc--    |   |      |   +-----| stack_pointer |<----+---->|   data   |
                +-------------+                   |   |      |   |     |               |     |     |  memory  |
                   ^    ^    ^                    |   |      |   |     +---------------+     |     |          |<--write--
                   |    |    |                    |   |      |   |             ^             |     |          |
                   |  input  |                    |   |      |   |             |             |     |          |
                   |      load_acc                V   V      V   V        latch_stack        |     |          |
                   |                            +-------------------+                        |     |          |
                   |                            |        ALU        |<---operation--         |     |          |
                   |                            |                   |<---operands---         |     |          |
                   |                            |-------------------|                        |     |          | 
                   |                 flags<-----|   Блок установки  |                        |     |          | 
                   |                            |       флагов      |                        |     |          |
                   |                            +-------------------+                        |     +----------+
                   |                                      |                                  |           ^
                   |                                      V                                  |           |
                   +---------------------------alu_out----+-----------------+----------------+           |
                                                          |                 |                            |
                                                          |                 +----data---->               |
                                       --load_adress--+   |                                              |
                                                      |   |                                    +---------+
                                                      V   V                                    |
                                                   +----------+                                |                    
                                                   |    MUX   |<---sel_addr--                  |
                                                   +----------+                                |
                                                         |                              +-------------+
                                                         +----------------------------->| address reg |<----latch_address--
                                                                                        +-------------+
``` 

Реализован в классе ```DataPath```.

- Управляющие сигналы для работы с регистрами и памятью. Реализована LRU-кэш для оптимизации операций с памятью.
- Поддерживаются инструкции для работы с регистрами, чтением/записью данных, математическими операциями в ALU.
- Вызовы инструкций `cmp` и установка флагов, по которым происходят условные переходы.

## Тестирование

Тестирование выполняется при помощи golden test-ов в формате yaml. Файлы .yml лежат в папке 
[tests](https://github.com/vatankh/comp_arch_lab3/tree/main/tests). Тесты содержат входные данные и проверку на
- код программы
- машинный код
- вывод процессора
- журнал работы процессора

**Алгоритмы и их тесты**

- ```hello_user_name.asm``` - [hello_user_test.yml](https://github.com/vatankh/comp_arch_lab3/blob/main/tests/hello_user_test2.yml)
- ```eulr.asm``` - [prob1_asm.yml](https://github.com/vatankh/comp_arch_lab3/blob/main/tests/eular_test.yml)

Наиболее подробно разобран алгоритм ```hello_user_name```
- Ввод:

   `Aleksander the great`

- Вывод:
    ```
  What is your name? 
    Hello, Aleksander the great! 
    ```
- Файл с кодом - [hello_user_name.asm](https://github.com/vatankh/comp_arch_lab3/blob/main/eular.asm)
- Журнал работы процессора - [processor.txt](https://github.com/vatankh/comp_arch_lab3/blob/main/machine/logs/processor.txt)


Основной файл с кодом теста находится в модуле [testRunning.py](https://github.com/vatankh/comp_arch_lab3/blob/main/testRunning.py)
